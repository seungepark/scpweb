<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper      
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"      
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssshi.ddms.mybatis.dao.CronDaoI">

	<select id="existShipInfo" parameterType="string" resultType="int">
		SELECT COUNT(SHIPNUM) FROM SHIPINFO
		WHERE SHIPNUM = #{shipNum}
	</select>
	
	<update id="updateShipInfo" parameterType="shipInfoBean">
		UPDATE SHIPINFO SET DOCK = #{dock}, MAINHULLNUM = #{mainHullNum}, PROJSEQ = #{projSeq}, SEQNO = #{seqNo}, 
			REGOWNER = #{regOwner}, SHIPTYPE = #{shipType}, TYPEMODEL = #{typeModel}, UPDATEBY = 1, UPDATEDATE = SYSDATE()
		WHERE SHIPNUM = #{shipNum}
	</update>
	
	<insert id="insertShipInfo" parameterType="shipInfoBean">
		INSERT INTO SHIPINFO (SHIPNUM, DOCK, MAINHULLNUM, PROJSEQ, SEQNO, REGOWNER, SHIPTYPE, TYPEMODEL, IMO, ISDEFAULT, STATUS, INSERTBY, INSERTDATE, UPDATEBY, UPDATEDATE)
		VALUES(#{shipNum}, #{dock}, #{mainHullNum}, #{projSeq}, #{seqNo}, #{regOwner}, #{shipType}, #{typeModel}, '', 'N', 'ACT', 1, SYSDATE() , 1, SYSDATE())
	</insert>
	
	<select id="getFileInfoFileList" resultType="string">
		SELECT SAVENAME FROM FILEINFO
	</select>
	
	<select id="getCronList" parameterType="cronInfoBean" resultType="cronInfoBean">
		SELECT SQL_CALC_FOUND_ROWS
			UID, CRONID, DESCRIPTION , STATUS , CRONCLASS, FREQUENCY, LASTRUNDATE, RUNCNT
		FROM CRONTASK
		WHERE 1 = 1
		<if test="cronid != null and cronid.length() > 0">
			AND UPPER(CRONID) LIKE CONCAT('%', UPPER(#{cronid}), '%')
		</if>
		<if test="description != null and description.length() > 0">
			AND UPPER(DESCRIPTION) LIKE CONCAT('%', UPPER(#{description}), '%')
		</if>
		<if test="status != null and status != 'ALL'">
			AND STATUS = #{status}
		</if>
		<if test="status == null or status == 'ALL'">
			AND STATUS IN ('ACT', 'INACT')
		</if>
		ORDER BY STATUS, UID
		LIMIT #{start}, #{limit} 
	</select>
	
	<select id="getCronListCnt" resultType="int">
		SELECT FOUND_ROWS()
	</select>
	
	<select id="getCron" parameterType="paramBean" resultType="cronInfoBean">
		SELECT UID, CRONID, DESCRIPTION, STATUS, FREQUENCY, CRONCLASS, LASTRUNDATE, RUNCNT
		FROM CRONTASK
		WHERE UID = #{uid}
	</select>
	
	<update id="updateCron" parameterType="cronInfoBean">
		UPDATE CRONTASK SET DESCRIPTION = #{description}, STATUS = #{status}, FREQUENCY = #{frequency}, CRONCLASS = #{cronclass}, RUNCNT = #{runcnt},
			UPDATEBY = #{userUid}, UPDATEDATE = SYSDATE()
		WHERE UID = #{uid}
	</update>
	
	<select id="checkExistCron" parameterType="cronInfoBean" resultType="int">
		SELECT COUNT(UID)
		FROM CRONTASK
		WHERE 1=1
		<if test="isExist == null">
			AND UID != #{uid}
		</if>
			AND CRONID = #{cronid}
	</select>
	
	<update id="changeStatusCron" parameterType="paramBean">
		UPDATE CRONTASK SET STATUS = #{status}, UPDATEBY = #{userUid}, UPDATEDATE = SYSDATE()
		WHERE UID = #{uid}
	</update>
	
	<delete id="deleteCron" parameterType="int">
		DELETE FROM CRONTASK WHERE UID = #{uid}
	</delete>
	
	<insert id="insertCron" parameterType="cronInfoBean">
		INSERT INTO CRONTASK (CRONID, DESCRIPTION, STATUS, FREQUENCY, CRONCLASS, RUNCNT, LASTRUNDATE, INSERTBY, INSERTDATE, UPDATEBY, UPDATEDATE)
		VALUES(#{cronid}, #{description}, #{status}, #{frequency}, #{cronclass}, 0, null, #{userUid}, SYSDATE() , #{userUid}, SYSDATE())
		<selectKey resultType="int" keyProperty="uid" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
	<update id="increaseCronRunCntAndDate" parameterType="string">
		UPDATE CRONTASK SET RUNCNT = (RUNCNT + 1), LASTRUNDATE = SYSDATE()
		WHERE CRONID = #{value}
	</update>
	
	<select id="getDomainInfoList" parameterType="string" resultType="domainInfoBean">
		SELECT DI.UID, DI.VAL, DI.INVAL, DI.DESCRIPTION
 		FROM DOMAININFO DI
			LEFT OUTER JOIN DOMAIN D ON (DI.DOMAINUID = D.UID)
		WHERE D.DOMAIN = #{value} 
		ORDER BY DI.UID
	</select>
	
	<select id="getVesselInfoData" parameterType="string" resultType="string">
		SELECT ${value}
 		FROM SHIPINFO
 		WHERE ISDEFAULT = 'Y'
 		LIMIT 1
	</select>
</mapper>