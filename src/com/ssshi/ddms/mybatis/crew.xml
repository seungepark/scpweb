<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper      
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"      
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="com.ssshi.ddms.mybatis.dao.CrewDaoI"> 

	<select id="getShipList" resultType="domainInfoBean">
		<!-- UID, trialKey, shipType -->
		SELECT 
		    S.HULLNUM as projNo,        
		    S.UID as val,           
		    S.TRIALKEY as description,        
		    SI.REGOWNER as regOwner,         
		    SI.SHIPTYPE as shipType,          
		    SI.PROJSEQ as projSeq,          
		    S.STATUS
		FROM SCHEDULERINFO S
		INNER JOIN SCHEDULERVERSIONINFO SVI ON (S.SCHEDULERVERSIONINFOUID = SVI.UID AND S.REVNUM = SVI.PLANREVNUM)
		LEFT OUTER JOIN SCHETRIALINFO TI ON (S.UID = TI.SCHEDULERINFOUID)
		LEFT OUTER JOIN SHIPINFO SI ON (S.HULLNUM = SI.SHIPNUM)
		LEFT OUTER JOIN USERINFO UI ON (S.INSERTBY = UI.UID)
		<!-- WHERE S.STATUS = 'ACT' -->
		WHERE S.TRIALKEY <![CDATA[ <> ]]> ''
		ORDER BY S.INSERTDATE desc
		
		<!-- 전체 호선리스트 -->
		<!-- SELECT SHIPNUM AS VAL, SHIPNUM AS DESCRIPTION FROM SHIPINFO WHERE TITLE <![CDATA[ <> ]]> ''; -->
	</select>
	
	<select id="getAnchShipList" resultType="domainInfoBean">
         SELECT
            SI.SHIPNUM AS val, 
            (SELECT DESCRIPTION
               FROM DOMAININFO D
              WHERE DOMAINUID IN (SELECT UID FROM DOMAIN WHERE DOMAIN = 'SHIPTYPE')
                AND D.VAL = SI.SHIPTYPE) AS shipTypeDes,
            SI.PROJSEQ AS projSeq,
            SI.STATUS AS status,
            SI.REGOWNER AS regOwner,
            SI.SHIPNUM AS description,
            0 AS schedulerUid
        FROM SHIPINFO SI         
        WHERE 1=1          
          AND SI.STATUS = 'ACT'
        ORDER BY SI.SHIPNUM ASC
    </select>
	
	<select id="getRegistrationCrewList" parameterType="RegistrationCrewBean" resultType="RegistrationCrewBean">
		SELECT S.UID,
		       S.SCHEDULERINFOUID AS schedulerInfoUid,
		       S.TRIALKEY,
		       S.PROJECT,
		       S.KIND,
		       S.COMPANY,
		       S.DEPARTMENT,
		       S.NAME,
		       S.RANK,
		       S.IDNO,
		       S.WORKTYPE1,
		       S.WORKTYPE2,
		       S.WORK,
		       S.MAINSUB,
		       S.FOODSTYLE,
		       S.PERSONNO,
		       S.GENDER,
		       S.PHONE,
		       MRU.ROOM_NO AS roomNo,
		       S.ISPLAN,
		       SD.TERMINAL,
		       SD.NOTEBOOK AS LAPTOP,
		       SD.MODEL_NAME AS MODELNM,
		       SD.SERIAL_NUMBER AS SERIALNO,
		       SD.FOREIGNER,
		       SD.PASSPORT_NUMBER AS PASSPORTNO,
		       SD.ORDER_STATUS AS ORDERSTATUS,
		       S.ISNONE,
		       S.DELETE_YN,
		       MLB.BOAT_NAME AS BOATNM,
		       MLB.ROLE AS ROLE
		  FROM SCHECREW S
		  LEFT OUTER JOIN SCHECREWDETAILINFO SD ON SD.SCHECREWUID = S.UID
		  LEFT OUTER JOIN mobile_room_userlist MRU
		    ON MRU.SCHEDULERINFOUID = S.SCHEDULERINFOUID
		   AND MRU.USER_UID = S.UID
		  LEFT OUTER JOIN mobile_lift_boat_crewinfo MLB 
		  	ON MLB.SCHEDULERINFOUID  = S.SCHEDULERINFOUID
		   and MLB.USER_UID  = S.UID  
		 WHERE S.TRIALKEY IS NOT NULL
		   AND S.PROJECT IS NOT NULL
		 <if test="schedulerInfoUid != null and schedulerInfoUid > 0">
		   AND S.SCHEDULERINFOUID = #{schedulerInfoUid}
		</if>
		order by S.UID DESC
	</select>
	
	<select id="getRegistrationCrewListBySchedulerInfoUid" parameterType="int" resultType="RegistrationCrewBean">
		SELECT S.UID,
		       S.SCHEDULERINFOUID AS schedulerInfoUid,
		       S.TRIALKEY,
		       S.PROJECT,
		       S.KIND,
		       S.COMPANY,
		       S.DEPARTMENT,
		       S.NAME,
		       S.RANK,
		       S.IDNO,
		       S.WORKTYPE1,
		       S.WORKTYPE2,
		       S.WORK,
		       S.MAINSUB,
		       S.FOODSTYLE,
		       S.PERSONNO,
		       S.GENDER,
		       S.PHONE,
		       MRU.ROOM_NO AS roomNo,
		       S.ISPLAN,
		       SD.TERMINAL,
		       SD.NOTEBOOK AS LAPTOP,
		       SD.MODEL_NAME AS MODELNM,
		       SD.SERIAL_NUMBER AS SERIALNO,
		       SD.FOREIGNER,
		       SD.PASSPORT_NUMBER AS PASSPORTNO,
		       SD.ORDER_STATUS AS ORDERSTATUS,
		       S.ISNONE,
		       S.DELETE_YN,
		       MLB.BOAT_NAME AS BOATNM,
		       MLB.ROLE AS ROLE
		  FROM SCHECREW S
		  LEFT OUTER JOIN SCHECREWDETAILINFO SD ON SD.SCHECREWUID = S.UID
		  LEFT OUTER JOIN mobile_room_userlist MRU
		    ON MRU.SCHEDULERINFOUID = S.SCHEDULERINFOUID
		   AND MRU.USER_UID = S.UID
		  LEFT OUTER JOIN mobile_lift_boat_crewinfo MLB 
		  	ON MLB.SCHEDULERINFOUID  = S.SCHEDULERINFOUID
		   and MLB.USER_UID  = S.UID 
		 WHERE S.SCHEDULERINFOUID = #{schedulerInfoUid}
	</select>
	
	<select id="getCrewInOutList" parameterType="ParamBean" resultType="scheCrewInOutBean">
		SELECT UID, INOUTDATE, SCHEDULERINOUT, PERFORMANCEINOUT 
		FROM SCHECREWINOUT
		WHERE SCHECREWUID = #{uid}
		<if test="inDate != null and inDate.length() > 0">
			AND DATE_FORMAT(SI.INOUTDATE, '%Y-%m-%d') <![CDATA[ >= ]]> #{startDate}
		</if>
		<if test="outDate != null and outDate.length() > 0">
			AND DATE_FORMAT(SI.INOUTDATE, '%Y-%m-%d') <![CDATA[ <= ]]> #{endDate}
		</if>	
		<!-- 기간조건을 승선일/하선일에만 적용 -->
		<!-- AND (SCHEDULERINOUT = 'B' OR PERFORMANCEINOUT = 'B' OR SCHEDULERINOUT = 'U' OR PERFORMANCEINOUT = 'U') -->
		ORDER BY INOUTDATE
	</select>
	
	<select id="getRegistrationCrewListCnt" resultType="int">
		SELECT FOUND_ROWS()
	</select>
					
	<insert id="insertRegistrationCrew" parameterType="RegistrationCrewBean">
		INSERT INTO SCHECREW (SCHEDULERINFOUID, TRIALKEY, PROJECT, KIND, COMPANY, DEPARTMENT, NAME, RANK, IDNO, WORKTYPE1, WORKTYPE2, WORK 
			,MAINSUB, FOODSTYLE, PERSONNO, GENDER, PHONE, ISPLAN, ISNONE, INSERTDATE, INSERTBY, UPDATEDATE, UPDATEBY, DELETE_YN)
		VALUES (#{schedulerInfoUid}, #{trialKey}, #{project}, #{kind}, #{company}, #{department}, #{name}, #{rank}, #{idNo}, #{workType1}, #{workType2}, #{work}
			,#{mainSub}, #{foodStyle}, #{personNo}, #{gender}, #{phone}, #{isPlan}, 'N', SYSDATE(), #{userUid}, SYSDATE(), #{userUid}, 'N')
		<selectKey resultType="int" keyProperty="uid" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
  	<insert id="insertCrewDetail" parameterType="RegistrationCrewDetailBean">
		INSERT INTO SCHECREWDETAILINFO (SCHECREWUID, SCHEDULERINFOUID, TERMINAL, NOTEBOOK, MODEL_NAME, SERIAL_NUMBER
			,FOREIGNER, PASSPORT_NUMBER, ORDER_STATUS, ORDER_DATE, ORDER_UID ,REG_DATE)
		VALUES (#{scheCrewUid}, #{schedulerInfoUid}, #{terminal}, #{laptop}, #{modelNm}, #{serialNo}
			, #{foreigner}, #{passportNo}, #{orderStatus}, SYSDATE(), #{userUid}, SYSDATE())
		<selectKey resultType="int" keyProperty="uid" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>   

	<delete id="deleteCrewList" parameterType="int">
		DELETE FROM SCHECREW
		WHERE UID = #{crewUid}
	</delete>
	
	<delete id="deleteCrewDetailList" parameterType="int">
		DELETE FROM SCHECREWDETAILINFO
		WHERE SCHECREWUID = #{crewUid}
	</delete>
	
	<delete id="deleteCrewInoutList" parameterType="int">
		DELETE FROM SCHECREWINOUT
		WHERE SCHECREWUID = #{crewUid}
	</delete>
	
	<update id="updateCrewOrder" parameterType="map">
		UPDATE SCHECREWDETAILINFO SET ORDER_STATUS = 'Y', ORDER_DATE = SYSDATE(), ORDER_UID = #{userId}
		WHERE SCHEDULERINFOUID = #{crewUid}
	</update>
		
	<select id="getAnchorageMealList" parameterType="AnchorageMealRequestBean" resultType="AnchorageMealRequestBean">
		select UID, SCHEDULERINFOUID as schedulerInfoUid, PROJ_NO as projNo, 
			TRIALKEY as trialKey, KIND as kind, DOMESTIC_YN as domesticYn, DEPT_NAME as department,
			MEAL_DATE as mealDate, ORDER_STATUS as orderStatus, ORDER_DATE as orderDate,
			ORDER_UID as orderUid, DEL_YN as deleteYn, COMMENT as comment, REG_DATE as inputDate, REG_USERNAME as inputUid
			from mobile_anchor_meal_info
			where 1=1 
		 <if test="ship != null and ship != 'ALL'" >
			AND PROJ_NO <![CDATA[ = ]]> #{ship}			
		 </if>
	</select>
	
	<select id="getAnchorageMealListBySchedulerInfoUid" parameterType="int" resultType="AnchorageMealRequestBean">
		select UID, SCHEDULERINFOUID as schedulerInfoUid, PROJ_NO as projNo, 
			TRIALKEY as trialKey, KIND as kind, DOMESTIC_YN as domesticYn, DEPT_NAME as department,
			MEAL_DATE as mealDate, ORDER_STATUS as orderStatus, ORDER_DATE as orderDate,
			ORDER_UID as orderUid, DEL_YN as deleteYn, COMMENT as comment, REG_DATE as inputDate, REG_USERNAME as inputUid
			from mobile_anchor_meal_info
		 where 1=1 
		   AND UID IS NOT NULL
		   AND SCHEDULERINFOUID = #{schedulerInfoUid}
	</select>
	
	<select id="getAnchorageMealListCnt" resultType="int">
		SELECT FOUND_ROWS()
	</select>
	
	<select id="getAnchorageMealPlanQtyList" parameterType="int" resultType = "AnchorageMealQtyBean">
		SELECT UID, ANCHOR_MEAL_UID, SCHEDULERINFOUID, TRIALKEY, MEAL_TIME as planMealTime,
		MEAL_GUBUN as planMealGubun, MEAL_DATE as planMealDate, MEAL_PLAN_QTY as planMealQty
		FROM mobile_anchor_meal_plancnt
		WHERE ANCHOR_MEAL_UID = #{anchorMealUid}
	</select>
	
	<!-- 기존 실적 수량 쿼리 (ANCHOR_MEAL_UID 기준) -->
	<!--
	<select id="getAnchorageMealResultQtyList" parameterType="int" resultType = "AnchorageMealQtyBean">
		SELECT ANCHOR_MEAL_UID,  MEAL_TIME as resultMealTime,
			   MEAL_GUBUN as resultMealGubun, MEAL_DATE as resultMealDate, COUNT(*) as resultMealPlanQty
		  FROM mobile_anchor_meal_userinfo
		 where 1=1
		   and ANCHOR_MEAL_UID = #{anchorMealUid}
		 group by ANCHOR_MEAL_UID, MEAL_TIME, MEAL_GUBUN, MEAL_DATE
	</select>
	-->
	
	<!-- 수정된 실적 수량 쿼리 (호선, 조회기간 기준, 부서별 집계) -->
	<select id="getAnchorageMealResultQtyList" parameterType="AnchorageMealRequestBean" resultType = "AnchorageMealQtyBean">
		SELECT ANCHOR_MEAL_UID, MEAL_TIME as resultMealTime,
			   MEAL_GUBUN as resultMealGubun, MEAL_DATE as resultMealDate, 
			   DEPT_NAME as department, COUNT(*) as resultMealQty
		  FROM mobile_anchor_meal_userinfo
		 where 1=1
		 <if test="ship != null and ship != '' and ship != 'ALL'">
		   AND PROJ_NO <![CDATA[ = ]]> #{ship}
		 </if>
		 <if test="inDate != null and inDate != ''">
		   AND MEAL_DATE <![CDATA[ >= ]]> #{inDate}
		 </if>
		 <if test="outDate != null and outDate != ''">
		   AND MEAL_DATE <![CDATA[ <= ]]> #{outDate}
		 </if>
		 group by ANCHOR_MEAL_UID, DEPT_NAME, MEAL_TIME, MEAL_GUBUN, MEAL_DATE
	</select>
	
	<delete id="deleteAnchList" parameterType="int">
		DELETE FROM mobile_anchor_meal_info
		WHERE UID = #{anchUid}
	</delete>
	
	<delete id="deleteAnchPlanList" parameterType="int">
		DELETE FROM mobile_anchor_meal_plancnt
		WHERE ANCHOR_MEAL_UID = #{anchUid}
	</delete>
	
	<delete id="deleteAnchResultList" parameterType="int">
		DELETE FROM mobile_anchor_meal_userinfo
		WHERE ANCHOR_MEAL_UID = #{anchUid}
	</delete>
	
	<insert id="insertAnchorageMeal" parameterType="AnchorageMealRequestBean">
		INSERT INTO mobile_anchor_meal_info (PROJ_NO, SCHEDULERINFOUID, TRIALKEY, KIND, DOMESTIC_YN, DEPT_NAME, MEAL_DATE, ORDER_STATUS, 
			ORDER_DATE, ORDER_UID, DEL_YN, COMMENT, REG_DATE, 
			REG_USERNAME,QR_DATE, ANDROID_ID, INSERT_DATE, INSERTBY, REG_DEVICE)
		VALUES (#{projNo}, 0, #{trialKey}, #{kind}, #{domesticYn}, #{department}, NULLIF(#{mealDate}, ''), #{orderStatus},
		     NULLIF(#{orderDate}, ''), NULLIF(#{orderUid}, ''), #{deleteYn}, #{comment}, SYSDATE(),
			 #{userUid}, null, null, SYSDATE(), #{userUid}, null)
		<selectKey resultType="int" keyProperty="uid" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>
	
  	<insert id="insertMealQty" parameterType="AnchorageMealQtyBean">
		INSERT INTO mobile_anchor_meal_plancnt (ANCHOR_MEAL_UID, SCHEDULERINFOUID, TRIALKEY, 
			MEAL_TIME, MEAL_GUBUN,
			MEAL_PLAN_QTY, DEL_YN, REG_DATE, REG_USERNAME, INSERTBY, REG_DEVICE)
		VALUES (#{anchorMealUid}, 0, #{projNo}, #{planMealTime}, #{planMealGubun}, #{planMealQty}
			, 'N', SYSDATE(), #{uuid}, null, null)
		<selectKey resultType="int" keyProperty="uid" order="AFTER">
	        SELECT LAST_INSERT_ID()
	    </selectKey>
	</insert>   
	
	<update id="updateAnchOrder" parameterType="map">
		UPDATE mobile_anchor_meal_info SET ORDER_STATUS = 'Y', ORDER_DATE = SYSDATE(), ORDER_UID = #{userId}
		WHERE UID = #{anchUid}
	</update>
	
	<select id="getCrewMealResultList" parameterType="RegistrationCrewRequestBean" resultType="RegistrationCrewRequestBean">
	  SELECT
			merged.UID,
			merged.SCHEDULERINFOUID AS schedulerInfoUid,
			merged.PROJ_NO AS projNo,
			merged.TRIALKEY AS trialKey,	
			merged.KIND AS kind,
			merged.DOMESTIC_YN AS domesticYn,
			merged.department,
			merged.MEAL_DATE AS mealDate,
			merged.ORDER_STATUS AS orderStatus,
			merged.ORDER_DATE AS orderDate,
			merged.ORDER_UID AS orderUid,
			merged.DEL_YN AS deleteYn,
			merged.COMMENT AS comment,
			merged.REG_DATE AS inputDate,
			merged.REG_USERNAME AS inputUid
		FROM (
			SELECT 
				NULL AS UID,
				userinfo.SCHEDULERINFOUID,
				userinfo.PROJ_NO,
				userinfo.TRIALKEY,
				NULL AS KIND,
				NULL AS DOMESTIC_YN,
				userinfo.DEPT_NAME AS department,
				DATE(userinfo.MEAL_DATE) AS MEAL_DATE,
				NULL AS ORDER_STATUS,
				NULL AS ORDER_DATE,
				NULL AS ORDER_UID,
				'N' AS DEL_YN,
				NULL AS COMMENT,
				NULL AS REG_DATE,
				NULL AS REG_USERNAME
			  FROM mobile_meal_userinfo userinfo
			 WHERE 1=1
			   AND userinfo.MEAL_DATE <![CDATA[ >= ]]> #{inDate}
			   AND userinfo.MEAL_DATE <![CDATA[ <= ]]> #{outDate}
			 <if test="ship != null and ship != '' and ship != 'ALL'">
				AND userinfo.SCHEDULERINFOUID <![CDATA[ = ]]> #{ship}
			 </if>
		) merged
		WHERE merged.department IS NOT NULL AND merged.department <![CDATA[ <> ]]> ''
		ORDER BY merged.MEAL_DATE, merged.department
	</select>
	
	<select id="getCrewMealListCnt" resultType="int">
		SELECT FOUND_ROWS()
	</select>
	
	<select id="getCrewPlanQtyList" parameterType="int" resultType = "RegistrationCrewQtyBean">
		SELECT null as UID, null as scheCrewUid, null as TRIALKEY, null as planMealTime,
		null as planMealGubun, null as planMealDate, 0 as planMealQty
		FROM dual
	</select>
	
	<select id="getCrewResultQtyList" parameterType="RegistrationCrewQtyBean" resultType = "RegistrationCrewQtyBean">
		SELECT MEAL_TIME as resultMealTime,
			   MEAL_GUBUN as resultMealGubun, MEAL_DATE as resultMealDate, 
			   DEPT_NAME as department, TRIALKEY as projNo, COUNT(*) as resultMealQty
		  FROM mobile_meal_userinfo
		 where 1=1
		 <if test="projNo != null and projNo != ''">
		   AND SCHEDULERINFOUID <![CDATA[ = ]]> #{projNo}
		 </if>
		 <if test="inDate != null and inDate != ''">
		   AND MEAL_DATE <![CDATA[ >= ]]> #{inDate}
		 </if>
		 <if test="outDate != null and outDate != ''">
		   AND MEAL_DATE <![CDATA[ <= ]]> #{outDate}
		 </if>
		 <if test="mealDate != null and mealDate != ''">
		   AND MEAL_DATE <![CDATA[ = ]]> #{mealDate}
		 </if>
		 group by TRIALKEY, SCHEDULERINFOUID, DEPT_NAME, MEAL_TIME, MEAL_GUBUN, MEAL_DATE
	</select>
	
	<select id="getCrewResultDeptCombinations" parameterType="RegistrationCrewRequestBean" resultType="RegistrationCrewRequestBean">
		SELECT DISTINCT 
			TRIALKEY AS projNo,
			DATE(MEAL_DATE) AS mealDate,
			DEPT_NAME AS department
		  FROM mobile_meal_userinfo
		 WHERE 1=1
		 <if test="inDate != null and inDate != ''">
			AND MEAL_DATE <![CDATA[ >= ]]> #{inDate}
		 </if>
		 <if test="outDate != null and outDate != ''">
			AND MEAL_DATE <![CDATA[ <= ]]> #{outDate}
		 </if>
		 <if test="ship != null and ship != '' and ship != 'ALL'">
			AND SCHEDULERINFOUID <![CDATA[ = ]]> #{ship}
		 </if>
		 ORDER BY projNo, mealDate, department
	</select>
	<!-- 실적집계리스트 -->
<!--
	<select id="getMealResultList" parameterType="AnchorageMealRequestBean" resultType="AnchorageMealRequestBean">
		select UID, SCHEDULERINFOUID as schedulerInfoUid, PROJ_NO as projNo, 
			TRIALKEY as trialKey, KIND as kind, DOMESTIC_YN as domesticYn, DEPT_NAME as department,
			MEAL_DATE as mealDate, ORDER_STATUS as orderStatus, ORDER_DATE as orderDate,
			ORDER_UID as orderUid, DEL_YN as deleteYn, COMMENT as comment, REG_DATE as inputDate, REG_USERNAME as inputUid
			from mobile_anchor_meal_info
			where 1=1 			 
			   and meal_date <![CDATA[ >= ]]> #{inDate}
			  and meal_date <![CDATA[ <= ]]> #{outDate} 
		 <if test="ship != null and ship != 'ALL'" >
			AND PROJ_NO <![CDATA[ = ]]> #{ship}			
		 </if>
	</select>
-->
	<select id="getMealResultList" parameterType="AnchorageMealRequestBean" resultType="AnchorageMealRequestBean">
		SELECT 
			merged.UID,
			merged.SCHEDULERINFOUID AS schedulerInfoUid,
			merged.PROJ_NO AS projNo,
			merged.TRIALKEY AS trialKey,
			merged.KIND AS kind,
			merged.DOMESTIC_YN AS domesticYn,
			merged.department,
			merged.MEAL_DATE AS mealDate,
			merged.ORDER_STATUS AS orderStatus,
			merged.ORDER_DATE AS orderDate,
			merged.ORDER_UID AS orderUid,
			merged.DEL_YN AS deleteYn,
			merged.COMMENT AS comment,
			merged.REG_DATE AS inputDate,
			merged.REG_USERNAME AS inputUid
		FROM (
			SELECT 
				info.UID,
				info.SCHEDULERINFOUID,
				info.PROJ_NO,
				info.TRIALKEY,
				info.KIND,
				info.DOMESTIC_YN,
				info.DEPT_NAME AS department,
				DATE(info.MEAL_DATE) AS MEAL_DATE,
				info.ORDER_STATUS,
				info.ORDER_DATE,
				info.ORDER_UID,
				info.DEL_YN,
				info.COMMENT,
				info.REG_DATE,
				info.REG_USERNAME
			  FROM mobile_anchor_meal_info info
			 WHERE 1=1
			   AND info.MEAL_DATE <![CDATA[ >= ]]> #{inDate}
			   AND info.MEAL_DATE <![CDATA[ <= ]]> #{outDate}
			 <if test="ship != null and ship != '' and ship != 'ALL'">
				AND info.PROJ_NO <![CDATA[ = ]]> #{ship}
			 </if>
			UNION
			SELECT 
				NULL AS UID,
				userinfo.SCHEDULERINFOUID,
				userinfo.PROJ_NO,
				userinfo.TRIALKEY,
				NULL AS KIND,
				NULL AS DOMESTIC_YN,
				userinfo.DEPT_NAME AS department,
				userinfo.MEAL_DATE AS MEAL_DATE,
				NULL AS ORDER_STATUS,
				NULL AS ORDER_DATE,
				NULL AS ORDER_UID,
				'N' AS DEL_YN,
				NULL AS COMMENT,
				NULL AS REG_DATE,
				NULL AS REG_USERNAME
			  FROM mobile_anchor_meal_userinfo userinfo
			 WHERE 1=1
			   AND userinfo.MEAL_DATE <![CDATA[ >= ]]> #{inDate}
			   AND userinfo.MEAL_DATE <![CDATA[ <= ]]> #{outDate}
			 <if test="ship != null and ship != '' and ship != 'ALL'">
				AND userinfo.PROJ_NO <![CDATA[ = ]]> #{ship}
			 </if>
		) merged
		WHERE merged.department IS NOT NULL AND merged.department <![CDATA[ <> ]]> ''
		ORDER BY merged.MEAL_DATE, merged.department
	</select>
	
	<select id="getMealResultListCnt" resultType="int">
		SELECT FOUND_ROWS()
	</select>
	
	<select id="getMealResultPlanQtyList" parameterType="int" resultType = "AnchorageMealQtyBean">
		SELECT UID, ANCHOR_MEAL_UID, SCHEDULERINFOUID, TRIALKEY, MEAL_TIME as planMealTime,
		MEAL_GUBUN as planMealGubun, MEAL_DATE as planMealDate, MEAL_PLAN_QTY as planMealQty
		FROM mobile_anchor_meal_plancnt
		WHERE 1=1
		  and ANCHOR_MEAL_UID = #{anchorMealUid}
		 <!--  and meal_date <![CDATA[ = ]]> #{mealDate}
		  and TRIALKEY <![CDATA[ = ]]> #{projNo}  -->
	</select>
	
	<!-- 기존 실적 수량 쿼리 (특정 날짜, 부서별) -->
	<!--
	<select id="getMealResultQtyList" parameterType="AnchorageMealQtyBean" resultType = "AnchorageMealQtyBean">
		SELECT ANCHOR_MEAL_UID,  MEAL_TIME as resultMealTime, DEPT_NAME as department, proj_no as projNo,
			   MEAL_GUBUN as resultMealGubun, MEAL_DATE as resultMealDate, COUNT(*) as resultMealQty
		  FROM mobile_anchor_meal_userinfo
		 where 1=1
		   and meal_date <![CDATA[ = ]]> #{mealDate}
		   and PROJ_NO <![CDATA[ = ]]> #{projNo} 
		   AND DEPT_NAME <![CDATA[ = ]]> #{department}
		 group by ANCHOR_MEAL_UID, MEAL_TIME, MEAL_GUBUN, MEAL_DATE
	</select>
	-->
	
	<!-- 수정된 실적 수량 쿼리 (호선, 조회기간 기준, 부서별, 식사구분별 집계) -->
	<select id="getMealResultQtyList" parameterType="AnchorageMealQtyBean" resultType = "AnchorageMealQtyBean">
		SELECT MEAL_TIME as resultMealTime,
			   MEAL_GUBUN as resultMealGubun, MEAL_DATE as resultMealDate, 
			   DEPT_NAME as department, PROJ_NO as projNo, COUNT(*) as resultMealQty
		  FROM mobile_anchor_meal_userinfo
		 where 1=1
		 <if test="projNo != null and projNo != ''">
		   AND PROJ_NO <![CDATA[ = ]]> #{projNo}
		 </if>
		 <if test="inDate != null and inDate != ''">
		   AND MEAL_DATE <![CDATA[ >= ]]> #{inDate}
		 </if>
		 <if test="outDate != null and outDate != ''">
		   AND MEAL_DATE <![CDATA[ <= ]]> #{outDate}
		 </if>
		 <if test="mealDate != null and mealDate != ''">
		   AND MEAL_DATE <![CDATA[ = ]]> #{mealDate}
		 </if>
		 group by PROJ_NO, DEPT_NAME, MEAL_TIME, MEAL_GUBUN, MEAL_DATE
	</select>
	
	<!-- 방정보 저장 -->
	<insert id="insertMobileRoomInfo" parameterType="MobileRoomInfoBean">
		INSERT INTO mobile_room_info (
			PROJ_NO, SCHEDULERINFOUID, TRIALKEY, DECK, ROOM_NO, ROOM_NAME, 
			TEL, SIZE_M2, BED_COUNT, BATHROOM_YN, STATUS, DEL_YN,
			ANDROID_ID, MOBILE_DEVICE_ID, REG_USERNAME, UPDATE_USERNAME
		)
		VALUES (
			#{projNo}, #{schedulerInfoUid}, #{trialKey}, #{deck}, #{roomNo}, #{roomName},
			NULLIF(#{tel}, ''), #{sizeM2}, #{bedCount}, NULLIF(#{bathroomYn}, ''), 
			COALESCE(#{status}, 'AVAILABLE'), COALESCE(#{delYn}, 'N'),
			NULLIF(#{androidId}, ''), NULLIF(#{mobileDeviceId}, ''), 
			#{regUsername}, #{updateUsername}
		)
		<selectKey resultType="long" keyProperty="uid" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<update id="updateRegistrationCrew" parameterType="RegistrationCrewBean">
		UPDATE SCHECREW
		   SET SCHEDULERINFOUID = #{schedulerInfoUid},
		       TRIALKEY = #{trialKey},
		       PROJECT = #{project},
		       KIND = #{kind},
		       COMPANY = #{company},
		       DEPARTMENT = #{department},
		       NAME = #{name},
		       RANK = #{rank},
		       IDNO = #{idNo},
		       WORKTYPE1 = #{workType1},
		       WORKTYPE2 = #{workType2},
		       WORK = #{work},
		       MAINSUB = #{mainSub},
		       FOODSTYLE = #{foodStyle},
		       PERSONNO = #{personNo},
		       GENDER = #{gender},
		       PHONE = #{phone},
		       ISPLAN = #{isPlan},
		       UPDATEDATE = SYSDATE(),
		       UPDATEBY = #{userUid}
		 WHERE UID = #{uid}
	</update>
	
	<delete id="deleteMobileRoomInfoBySchedulerInfoUid" parameterType="int">
		DELETE FROM mobile_room_info
		WHERE SCHEDULERINFOUID = #{schedulerInfoUid}
	</delete>
	
	<!-- 방배정명단 저장 -->
	<insert id="insertMobileRoomUserlist" parameterType="MobileRoomUserlistBean">
		INSERT INTO mobile_room_userlist (
			PROJ_NO, SCHEDULERINFOUID, TRIALKEY, ROOM_NO, DEPARTMENT, NAME,
			PHONE, USER_UID, CHECK_IN_DATE, CHECK_OUT_DATE, STATUS, DEL_YN,
			ANDROID_ID, MOBILE_DEVICE_ID, REG_USERNAME, UPDATE_USERNAME
		)
		VALUES (
			#{projNo}, #{schedulerInfoUid}, #{trialKey}, #{roomNo}, 
			NULLIF(#{department}, ''), #{name}, NULLIF(#{phone}, ''),
			#{userUid}, 
			<choose>
				<when test="checkInDate != null and checkInDate != ''">
					STR_TO_DATE(#{checkInDate}, '%Y-%m-%d')
				</when>
				<otherwise>
					NULL
				</otherwise>
			</choose>,
			<choose>
				<when test="checkOutDate != null and checkOutDate != ''">
					STR_TO_DATE(#{checkOutDate}, '%Y-%m-%d')
				</when>
				<otherwise>
					NULL
				</otherwise>
			</choose>,
			COALESCE(#{status}, 'CHECKED_IN'), COALESCE(#{delYn}, 'N'),
			NULLIF(#{androidId}, ''), NULLIF(#{mobileDeviceId}, ''), 
			#{regUsername}, #{updateUsername}
		)
		<selectKey resultType="long" keyProperty="uid" order="AFTER">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<delete id="deleteMobileRoomUserlistBySchedulerInfoUid" parameterType="int">
		DELETE FROM mobile_room_userlist
		WHERE SCHEDULERINFOUID = #{schedulerInfoUid}
	</delete>
	
	<!-- 방정보 목록 조회 -->
	<select id="getMobileRoomInfoList" parameterType="int" resultType="MobileRoomInfoBean">
		SELECT 
			UID as uid,
			PROJ_NO as projNo,
			SCHEDULERINFOUID as schedulerInfoUid,
			TRIALKEY as trialKey,
			DECK as deck,
			ROOM_NO as roomNo,
			ROOM_NAME as roomName,
			TEL as tel,
			SIZE_M2 as sizeM2,
			BED_COUNT as bedCount,
			BATHROOM_YN as bathroomYn,
			STATUS as status,
			DEL_YN as delYn,
			ANDROID_ID as androidId,
			MOBILE_DEVICE_ID as mobileDeviceId,
			INSERT_DATE as insertDate,
			REG_USERNAME as regUsername,
			UPDATE_DATE as updateDate,
			UPDATE_USERNAME as updateUsername
		FROM mobile_room_info
		WHERE SCHEDULERINFOUID = #{schedulerInfoUid}
			AND DEL_YN = 'N'
		ORDER BY ROOM_NO
	</select>
	
	<!-- 방배정명단 목록 조회 -->
	<select id="getMobileRoomUserlist" parameterType="int" resultType="MobileRoomUserlistBean">
		SELECT 
			MR.UID as uid,
			MR.PROJ_NO as projNo,
			MR.SCHEDULERINFOUID as schedulerInfoUid,
			MR.TRIALKEY as trialKey,
			MR.ROOM_NO as roomNo,
			MR.DEPARTMENT as department,
			MR.NAME as name,
			MR.PHONE as phone,
			COALESCE(MR.USER_UID, SC.UID) as userUid,
			DATE_FORMAT(MR.CHECK_IN_DATE, '%Y-%m-%d') as checkInDate,
			DATE_FORMAT(MR.CHECK_OUT_DATE, '%Y-%m-%d') as checkOutDate,
			MR.STATUS as status,
			MR.DEL_YN as delYn,
			MR.ANDROID_ID as androidId,
			MR.MOBILE_DEVICE_ID as mobileDeviceId,
			MR.INSERT_DATE as insertDate,
			MR.REG_USERNAME as regUsername,
			MR.UPDATE_DATE as updateDate,
			MR.UPDATE_USERNAME as updateUsername
		FROM mobile_room_userlist MR
		LEFT OUTER JOIN SCHECREW SC ON (
			MR.USER_UID IS NULL
			AND SC.SCHEDULERINFOUID = MR.SCHEDULERINFOUID
			AND SC.PHONE = MR.PHONE
			AND (SC.DELETE_YN IS NULL OR SC.DELETE_YN != 'Y')
		)
		WHERE MR.SCHEDULERINFOUID = #{schedulerInfoUid}
			AND MR.DEL_YN = 'N'
		ORDER BY MR.ROOM_NO, MR.NAME
	</select>
	
	<select id="getMealDepartmentList" parameterType="AnchorageMealRequestBean" resultType="string">
		SELECT dept_name
		  FROM (
			SELECT DISTINCT DEPT_NAME AS dept_name
			  FROM mobile_anchor_meal_info
			 WHERE 1=1
			 <if test="inDate != null and inDate != ''">
				AND MEAL_DATE <![CDATA[ >= ]]> #{inDate}
			 </if>
			 <if test="outDate != null and outDate != ''">
				AND MEAL_DATE <![CDATA[ <= ]]> #{outDate}
			 </if>
			 <if test="ship != null and ship != '' and ship != 'ALL'">
				AND PROJ_NO <![CDATA[ = ]]> #{ship}
			 </if>
			UNION
			SELECT DISTINCT DEPT_NAME AS dept_name
			  FROM mobile_anchor_meal_userinfo
			 WHERE 1=1
			 <if test="inDate != null and inDate != ''">
				AND MEAL_DATE <![CDATA[ >= ]]> #{inDate}
			 </if>
			 <if test="outDate != null and outDate != ''">
				AND MEAL_DATE <![CDATA[ <= ]]> #{outDate}
			 </if>
			 <if test="ship != null and ship != '' and ship != 'ALL'">
				AND PROJ_NO <![CDATA[ = ]]> #{ship}
			 </if>
		  ) dept
		 WHERE dept_name IS NOT NULL AND dept_name <![CDATA[ <> ]]> ''
		 ORDER BY dept_name
	</select>
	
	<select id="getMealResultDeptCombinations" parameterType="AnchorageMealRequestBean" resultType="AnchorageMealRequestBean">
		SELECT DISTINCT 
			PROJ_NO AS projNo,
			DATE(MEAL_DATE) AS mealDate,
			DEPT_NAME AS department
		  FROM mobile_anchor_meal_userinfo
		 WHERE 1=1
		 <if test="inDate != null and inDate != ''">
			AND MEAL_DATE <![CDATA[ >= ]]> #{inDate}
		 </if>
		 <if test="outDate != null and outDate != ''">
			AND MEAL_DATE <![CDATA[ <= ]]> #{outDate}
		 </if>
		 <if test="ship != null and ship != '' and ship != 'ALL'">
			AND PROJ_NO <![CDATA[ = ]]> #{ship}
		 </if>
		 ORDER BY projNo, mealDate, department
	</select>
	
</mapper>